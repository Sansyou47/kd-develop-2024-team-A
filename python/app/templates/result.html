<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ツイッター周りのmeta設定 -->
    <meta name="x:card" content="summary_large_image" />
    <meta name="x:site" content="(2)Twitterのユーザー名" />
    <meta name="x:title" content="(3)ページのタイトル" />
    <meta name="x:description" content="(4)ページの説明文" />
    <meta name="x:image" content="https://kda.sansyou47.com/static/images/pinterest_board_photo.png" />
    <title>結果画面</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="https://unpkg.com/apexcharts/dist/apexcharts.min.js"></script>
</head>

<body class="bg-gray-100">
    <!-- ヘッダー -->
    {% include "header.html" %}

    <div class="container mx-auto">
        <!-- 結果画面 -->

        <!-- 点数とプレビュー -->
        <div class="bg-white rounded-lg shadow-md mx-6 mt-4 p-6">
            <div class="flex justify-between items-center">

                <!-- 点数 -->
                <div class="text-4xl text-center font-bold ">
                    <p id="colorScoreInc">{{color_score_inc|safe}}</p>
                    <div class="text-xl text-right">点<br>{{token_point}}</div>
                </div>

                <!-- プレビュー -->
                <div class="w-1/2">
                    <img src="{{ data_uri }}" alt="Bento" class="w-full h-auto rounded-lg">
                </div>
            </div>
        </div>

        <!-- 採点理由セクション -->
        <div class="mx-auto mt-4 px-6">
            <div class="bg-white rounded-lg shadow-md p-6 mt-4">
                <h2 class="text-center text-xl font-bold">採点理由</h2>
                <p class="text-lg">
                    {{nakai_color_zen|safe}}
                </p>
            </div>
        </div>

        <!-- Xで共有ボタンのセクション -->
        <div class="flex justify-center mt-4">
            <!-- "{{ data_uri }}" の画像を端末に保存とSNSでシェアするを１つのボタンで行う -->
            <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700"
                onclick="downloadImage();shareSNS()">画像を保存してシェア</button>
            <script>
                function downloadImage() {
                    var a = document.createElement('a');
                    a.href = "{{ data_uri }}";
                    a.download = 'bento.png';
                    a.click();
                }

                function shareSNS() {
                    window.open('http://twitter.com/share?url=https://kda.sansyou47.com/&text=わたしのお弁当の点数は{{color_score_inc|safe}}点でした！%0ASnapScoreではお弁当の色合いを点数化できます！%0Aあなたもお昼休みなどに使ってみませんか？%0A&hashtags=SnapScore');
                }
            </script>

            <script>
                // <a href="http://twitter.com/share?url=https://kda.sansyou47.com/&text=testest">
                //     <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700">
                //         SNSで共有
                //     </button>
                // </a >
            </script>
        </div>





        <!-- 分析セクション -->
        <div class="mx-auto mt-4 px-6">
            <div class="bg-white rounded-lg shadow-md p-6 mt-4">
                <h2 class="text-center text-xl font-bold">採点詳細</h2>
                <p class="text-lg">
                    {% if response is not none %}
                    {{ response|safe }}<br>
                    {% endif %}
                    {{ reason|safe }}
                </p>
            </div>

            <!-- グラフセクション -->
            <details class="bg-white rounded-lg shadow-md p-6 mt-4">
                <summary class="text-center text-xl font-bold cursor-pointer">お弁当の主要な色</summary>
                <div id="chart" class="bg-gray-50 p-4 rounded-lg mx-auto max-w-full h-96 mt-4"></div>
            </details>

            <!-- 不足している色・食材セクション -->
            <details class="bg-white rounded-lg shadow-md p-6 mt-4 mb-6">
                <summary class="text-center text-xl font-bold cursor-pointer">不足している色・食材</summary>
                <div class="mt-4">{{ Shortage_result | safe }}</div>
            </details>
        </div>
    </div>

    <script>
        var colorCode = {{ colors_code | tojson}};
        var colorPer = {{ colors_per | tojson}};
        var colorName = {{ color_graph | tojson}};
        var colorPerNum = colorPer.map(Number);
        var options = {
            series: colorPer,
            chart: {
                width: '80%',
                type: 'pie',
            },
            labels: colorName,
            colors: colorCode,
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: '100%',
                        height: '450px'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        function animateScore(newScore) {
            const scoreElement = document.getElementById('colorScoreInc');
            let numberTrial = 0;

            const interval = setInterval(() => {
                numberTrial += 1;
                let randomScore = Math.floor(Math.random() * 101);
                if (numberTrial >= 40) {
                    randomScore = newScore;
                    clearInterval(interval);
                }
                scoreElement.textContent = randomScore;
            }, 25);
        }

        animateScore({{ color_score_inc }});
    </script>
</body>

</html>