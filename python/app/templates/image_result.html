<!-- 結果画面 -->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ツイッター周りのmeta設定 -->
    <meta name="x:card" content="summary_large_image" />
    <meta name="x:site" content="(2)Twitterのユーザー名" />
    <meta name="x:title" content="(3)ページのタイトル" />
    <meta name="x:description" content="(4)ページの説明文" />
    <meta name="x:image" content="https://kda.sansyou47.com/static/images/pinterest_board_photo.png" />
    <title>結果画面</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="https://unpkg.com/apexcharts/dist/apexcharts.min.js"></script>
</head>

<body class="bg-gray-100">
    <!-- ヘッダー -->
    {% include "header.html" %}

    <div class="container mx-auto">
        <!-- 結果画面 -->

        <!-- 点数とプレビュー -->
        <div class="bg-white rounded-lg shadow-md mx-6 mt-4 p-6">
            <div class="flex justify-between items-center">

                <!-- 点数 -->
                <div class="text-4xl text-center font-bold ">
                    <p id="colorScoreInc">{{color_score_inc|safe}}</p>
                    <div class="text-xl text-right">点<br>{{token_point}}</div>
                </div>

                <!-- プレビュー -->
                <div class="w-1/2">
                    <img src="{{ data_uri }}" alt="Bento" class="w-full h-auto rounded-lg">
                </div>
            </div>
        </div>

        <!-- 採点理由セクション -->
        <div class="mx-auto mt-4 px-6">
            <div class="bg-white rounded-lg shadow-md p-6 mt-4">
                <h2 class="text-center text-xl font-bold">採点理由</h2>
                <p class="text-lg">
                    {{nakai_color_zen|safe}}
                </p>
            </div>
        </div>

        <!-- Xで共有ボタンのセクション -->
        <div class="flex justify-center mt-4">
            <!-- "{{ data_uri }}" の画像を端末に保存とSNSでシェアするを１つのボタンで行う -->
            <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700"
                onclick="downloadImage();shareSNS()">画像を保存してシェア</button>
            <script>
                function downloadImage() {
                    var a = document.createElement('a');
                    a.href = "{{ data_uri }}";
                    a.download = 'bento.png';
                    a.click();
                }

                function shareSNS() {
                    window.open('http://twitter.com/share?url=https://kda.sansyou47.com/&text=わたしのお弁当の点数は{{color_score_inc|safe}}点でした！%0ASnapScoreではお弁当の色合いを点数化できます！%0Aあなたもお昼休みなどに使ってみませんか？%0A&hashtags=SnapScore');
                }
            </script>

            <script>
                // <a href="http://twitter.com/share?url=https://kda.sansyou47.com/&text=testest">
                //     <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700">
                //         SNSで共有
                //     </button>
                // </a >
            </script>
        </div>





        <!-- 分析セクション -->
        <div class="mx-auto mt-4 px-6">
            <div class="bg-white rounded-lg shadow-md p-6 mt-4">
                <h2 class="text-center text-xl font-bold">採点詳細</h2>
                <p class="text-lg">
                    {% if response is not none %}
                    {{ response|safe }}<br>
                    {% endif %}

                    <!--グラフ切り替えボタン-->
                    <button id="change_button"
                        class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 border-b-0 ml-4 -mb-2 relative z-0 hidden">レーダチャートに切り替え</button>
                    <!--色の点数棒グラフ  -->
                <div id="bar-chart"
                    class="bg-blue-100 border border-blue-900 p-4 rounded-lg mx-auto max-w-full h-96 mt-0 relative z-10">
                </div>
                <!--色の点数レーダーグラフ  -->
                <div id="radar-chart"
                    class="bg-blue-100 border border-blue-900 p-4 rounded-lg mx-auto max-w-full h-96 mt-0 hidden">
                </div>
                </p>
            </div>

            <!-- グラフセクション -->
            <details class="bg-white rounded-lg shadow-md p-6 mt-4">
                <summary class="text-center text-xl font-bold cursor-pointer">お弁当の主要な色</summary>
                <div id="pie-chart"
                    class="bg-blue-100 border border-blue-900 p-4 rounded-lg mx-auto max-w-full h-96 mt-4"></div>
            </details>

            <!-- 不足している色・食材セクション -->
            <details class="bg-white rounded-lg shadow-md p-6 mt-4 mb-6">
                <summary class="text-center text-xl font-bold cursor-pointer">不足している色・食材</summary>
                <div class="mt-4">{{ Shortage_result | safe }}</div>
            </details>
        </div>
    </div>

    <script>
        var screenWidth = window.innerWidth; //画面の横幅
        var colorCode = {{ colors_code | tojson}};
        var colorPer = {{ colors_per | tojson}};
        var colorName = {{ color_graph | tojson}};
        var colorPerNum = colorPer.map(Number);

        //横幅が変わった時に取得するコード
        window.addEventListener("resize", function () {
            var screenWidth = window.innerWidth;
        });

        //円グラフの設定
        var pieOptions = {
            series: colorPer,
            chart: {
                width: '80%',
                type: 'pie',
            },
            labels: colorName,
            colors: colorCode,
            legend: {
                show: true
            },
            responsive: [{ //レスポンシブ表示
                breakpoint: 480, //画面サイズが480以下なら
                options: {
                    chart: {
                        width: '100%',
                        height: '450px'
                    },
                    legend: {
                        position: 'top'
                    }
                }
            }]
        };

        //円グラフの設定を変数に代入
        var pieChart = new ApexCharts(document.querySelector("#pie-chart"), pieOptions);
        //円グラフを描画する
        pieChart.render();

        var colorPoint = {{ color_point | tojson }};
        var colorPointNameCode = {{ color_point_name_code | tojson }};
        var colorPointNameJp = {{ color_point_name_jp | tojson }};

        //棒グラフの設定
        var barOptions = {
            series: [{
                name: '色点数',
                data: colorPoint,
            }],
            chart: {
                type: 'bar'
            },
            plotOptions: {
                bar: {
                    distributed: true, // 棒ごとに異なる色を使用
                    borderRadius: 4 // 棒の角を丸くするオプション
                }
            },
            colors: colorPointNameCode, //メインの色を設定
            xaxis: {
                categories: colorPointNameJp // X軸のラベルに日本語名を設定
            },
            yaxis: {
                max: 100 // Y軸の最大値を設定
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: '#ffffff' //ラベルの基本色
                },
                background: {
                    enabled: true, //ラベルの背景を有効か
                    foreColor: '#e3e3e3', //ラベルの中の文字の色を設定
                    padding: 4, //背景内側の余白
                    borderRadius: 10, //境界線の丸み
                    borderWidth: 1, //境界線の太さ
                    borderColor: '#e3e3e3', //境界線の色
                    opacity: 0.9 //背景の透過度
                }
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: '100%',
                        height: screenWidth
                    }
                }
            }]
        };

        //棒グラフの設定を変数に代入
        var barChart = new ApexCharts(document.querySelector("#bar-chart"), barOptions);
        //棒グラフを描画する
        barChart.render();

        var radarOptions = {
            series: [{
                name: '色点数',
                data: colorPoint,
            }],
            chart: {
                type: 'radar'
            },
            colors: ['orange'],
            xaxis: {
                categories: colorPointNameJp
            },
            yaxis: {
                max: 100,
                stepSize: 20
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: '100%'
                    }
                }
            }]
        }
        //レーダーグラフの設定を変数に代入
        var radarChart = new ApexCharts(document.querySelector("#radar-chart"), radarOptions);
        //レーダーグラフを描画する
        radarChart.render();

        //点数アニメーション
        function animateScore(newScore) {
            const scoreElement = document.getElementById('colorScoreInc');
            let numberTrial = 0;

            const interval = setInterval(() => {
                numberTrial += 1;
                let randomScore = Math.floor(Math.random() * 101);
                if (numberTrial >= 40) {
                    randomScore = newScore;
                    clearInterval(interval);
                }
                scoreElement.textContent = randomScore;
            }, 25);
        }

        animateScore({{ color_score_inc }});
    </script>
</body>

</html>