from flask import Blueprint, render_template, request, session
from werkzeug.security import generate_password_hash
from function import mysql
import re

# Blueprintã®ç™»éŒ²ï¼ˆåå‰ã¯ãƒ•ã‚¡ã‚¤ãƒ«åãŒå®šä¾‹ï¼‰
app = Blueprint("signup", __name__)

@app.route('/signup', methods=['GET', 'POST'])
def signup():
    error = None
    email = ''
    name = ''
    if request.method == 'POST':
        email = request.form.get('email')
        name = request.form.get('name')
        password = request.form.get('password')
        password_confirmation = request.form.get('password_confirmation')

        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒã‚§
        if email.count('@') != 1:
            error = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¯ã€Œ@ã€ãŒ1ã¤å«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'
        
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒã‚§
        if not error:
            mysql.cur.execute('SELECT * FROM users where email = %s', (email,))
            user = mysql.cur.fetchone()
            if user:
                error = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®é•·ã•ãƒã‚§ãƒã‚§
        if not error:
            if len(name) < 2:
                error = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯2æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'
        if not error:
            if len(name) > 10:
                error = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯10æ–‡å­—ä»¥å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'

        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ã¨æ–‡å­—ãƒã‚§ãƒã‚§
        if not error:
            if len(password) < 8:
                error = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'
            elif not re.search(r'\d', password):
                error = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å°‘ãªãã¨ã‚‚1ã¤ã®æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'
            elif not re.search(r'[a-zA-Z]', password):
                error = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å°‘ãªãã¨ã‚‚1ã¤ã®è‹±å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'
            elif password != password_confirmation:
                error = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãŒä¸€è‡´ã—ã¾ã›ã‚“'
            else:
                hashed_password = generate_password_hash(password)

        # ãªã‚“ã‚‚å•é¡Œãªã‹ã£ãŸã‚‰æ–°è¦ç™»éŒ²
        if not error:
            try:
                # æ–°è¦ç™»éŒ²ã®SQL
                    sql = 'INSERT INTO users (name, password, email) VALUES (%s, %s, %s)'
                    mysql.cur.execute(sql, (name, hashed_password, email))
                    mysql.conn.commit()
                    return render_template('login.html')
            except Exception as e:
                if session.get('user_id') == 1: # ã‚‚ã— sessionã®user_idãŒç®¡ç†è€…ã®ã¨ã ã‚¨ãƒ©ãƒ¼å…¨æ–‡ã‚’è¿”ã™
                    return
                else:
                    title = 'Oopsï¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¡ã‚ƒã£ãŸï¼ğŸ˜­'
                    message = 'ã‚¢ãƒ—ãƒªã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸã¿ãŸã„ï¼ç”³ã—è¨³ãªã„ã‘ã©ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ã­ã€‚'
                    return render_template('error.html', title=title, message=message, error=e)
                # return str(e)
        

    return render_template('signup.html', error=error, email=email, name=name)

# ãƒšãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ãƒ‡ãƒãƒƒã‚¯
# @app.route('/signup', methods=['GET', 'POST'])
# def signup():
#     return render_template('signup.html')

if __name__ == '__main__':
    app.run(debug=True)